#include "bsp_12864.h"

#define	LCD12864_A0_LOW()				HAL_GPIO_WritePin(LCD_A0_GPIO_Port, LCD_A0_Pin, GPIO_PIN_RESET)
#define	LCD12864_A0_HIGH()				HAL_GPIO_WritePin(LCD_A0_GPIO_Port, LCD_A0_Pin, GPIO_PIN_SET)
#define	LCD12864_CS_LOW()				HAL_GPIO_WritePin(LCD_CS_GPIO_Port, LCD_CS_Pin, GPIO_PIN_RESET)
#define	LCD12864_CS_HIGH()				HAL_GPIO_WritePin(LCD_CS_GPIO_Port, LCD_CS_Pin, GPIO_PIN_SET)

#define	LCD12864_SDA(state)				HAL_GPIO_WritePin(LCD_SDA_GPIO_Port, LCD_SDA_Pin, state)
#define	LCD12864_SCK(state)				HAL_GPIO_WritePin(LCD_SCK_GPIO_Port, LCD_SCK_Pin, state)

#define	LCD12864_TIMEOUT				100

lcd12864_t  lcd12864;
//-----------------------------------
// dispaly data (132x32)
//-----------------------------------
u8  Logo[]={
0x07,0x01,0x01,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x40,0x80,0x40,0x80,
0x40,0x80,0x40,0x80,0x40,0xA0,0x40,0xA0,0x40,0xA0,0x50,0xA0,0x50,0xA0,0x50,0xA8,
0x50,0xA8,0x50,0xA8,0x54,0xA8,0x54,0x28,0x14,0xAA,0x94,0xCA,0xC4,0xEA,0xE4,0xE2,
0xF5,0xF2,0xF9,0xFA,0xF9,0xF8,0xFD,0xFC,0xFD,0xFC,0xFD,0xFC,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x00,0x00,
0x40,0x40,0xC0,0x40,0x40,0x40,0x40,0x00,0x00,0x80,0x80,0xA0,0xC0,0x80,0x80,0xC0,
0xA0,0x80,0x80,0x80,0x00,0x80,0x40,0x20,0xC0,0x00,0xE0,0x00,0xC0,0x00,0xE0,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0x01,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x41,0xA8,0x55,0xAA,0x55,0xAA,
0x55,0x2A,0x95,0xCA,0xE5,0xF2,0xF9,0xF8,0xFD,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,
0x11,0xFF,0x09,0x15,0x08,0xFE,0x89,0x88,0x88,0xF8,0x00,0x00,0x04,0x05,0x06,0xF4,
0x57,0x54,0x54,0x57,0x54,0xF6,0x05,0x04,0x00,0x08,0xFC,0x02,0x85,0x75,0x15,0xF5,
0x45,0x9E,0x61,0x9F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0xA8,0x54,0x2A,0x95,0xCA,
0xE5,0xF2,0xF9,0xFC,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x10,0x10,0x10,0xD0,
0x10,0x10,0x10,0x10,0x11,0xD1,0x90,0x10,0x90,0xD1,0x10,0x10,0x90,0xD1,0x10,0x10,
0x10,0x90,0x50,0x51,0x51,0x91,0x11,0x91,0x51,0x51,0x50,0x90,0x10,0x90,0x51,0x51,
0x50,0x90,0x10,0x90,0x51,0x50,0x50,0x90,0x11,0x10,0x90,0x50,0x90,0x10,0x10,0x10,
0x10,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x80,0x80,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x20,0x14,0xCA,0xE1,0xF8,
0xFC,0xFF,0xFF,0xFB,0xFB,0xC3,0xFB,0xFB,0xFF,0xE7,0xDB,0xDB,0xDB,0xE7,0xFF,0xC3,
0xEB,0xEB,0xEB,0xF7,0xFF,0xE3,0xDF,0xEF,0xDF,0xE3,0xFF,0xCF,0xE7,0xEB,0xE7,0xCF,
0xFF,0xFB,0xF7,0xCF,0xF7,0xFB,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,
0x40,0x40,0x40,0x5F,0x50,0x50,0x50,0x50,0x40,0x5F,0x40,0x43,0x40,0x5F,0x40,0x40,
0x50,0x5F,0x50,0x40,0x40,0x48,0x50,0x52,0x52,0x4D,0x40,0x50,0x58,0x54,0x52,0x51,
0x40,0x48,0x50,0x52,0x52,0x4D,0x40,0x50,0x58,0x54,0x52,0x51,0x40,0x5F,0x42,0x42,
0x42,0x5F,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xE0
};

static void bsp_lcd12864_reset(void)
{
	HAL_GPIO_WritePin(LCD_RST_GPIO_Port, LCD_RST_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(LCD_RST_GPIO_Port, LCD_RST_Pin, GPIO_PIN_RESET);
	HAL_Delay(1);
	HAL_GPIO_WritePin(LCD_RST_GPIO_Port, LCD_RST_Pin, GPIO_PIN_SET);
	HAL_Delay(100);
}

static void lcd12864_wrcmd(u8 cmd)
{
	lcd12864_t *pdev = &lcd12864;
	u8 sdat,i;
	
	LCD12864_SCK(GPIO_PIN_SET);
	LCD12864_A0_LOW();// 选择指令通道
	LCD12864_CS_LOW(); // 选通模块
	sdat = cmd;
//	HAL_SPI_Transmit(pdev->p_spi, &sdat, 1, LCD12864_TIMEOUT);
	for(i=0;i<8;i++)	{
		if(sdat&0x80)	{
			LCD12864_SDA(GPIO_PIN_SET);
		}
		else
			LCD12864_SDA(GPIO_PIN_RESET);
		LCD12864_SCK(GPIO_PIN_RESET);
		LCD12864_SCK(GPIO_PIN_SET);
		sdat <<= 1;
	}
	LCD12864_CS_HIGH();
}

static void lcd12864_wrdata(u8 data)
{
	lcd12864_t *pdev = &lcd12864;
	u8 sdat,i;
	
	LCD12864_SCK(GPIO_PIN_SET);
	LCD12864_A0_HIGH();// 选择数据通道
	LCD12864_CS_LOW(); // 选通模块
	sdat = data;
//	HAL_SPI_Transmit(pdev->p_spi, &sdat, 1, LCD12864_TIMEOUT);
	for(i=0;i<8;i++)	{
		if(sdat&0x80)	{
			LCD12864_SDA(GPIO_PIN_SET);
		}
		else
			LCD12864_SDA(GPIO_PIN_RESET);
		LCD12864_SCK(GPIO_PIN_RESET);
		LCD12864_SCK(GPIO_PIN_SET);
		sdat <<= 1;
	}
	LCD12864_CS_HIGH();
}
//-----------------------------------
// Write a Screen
//-----------------------------------
void lcd12864_WriteScreen(u8 *DisplayData)	// DisplayData should be 132x32/8 byte
{
	u8 TempData;
	u16 i, j;
	
	for(i=0;i<4;i++)
	{
		lcd12864_wrcmd(0xb0 | i);	// select page
		lcd12864_wrcmd(0x10);	    // start form column 0
		lcd12864_wrcmd(0x00);	    // (2byte command)
		for(j=0;j<132;j++)
		{
			TempData = (*(DisplayData+(i*132)+j));
			lcd12864_wrdata(TempData);
		}
	}
}

//-----------------------------------
// Contrast control
//-----------------------------------
void lcd12864_LCDDarker(void)
{
	if (lcd12864.ContrastLevel<0x3F)
	{
		lcd12864.ContrastLevel++;
	}
    lcd12864_wrcmd(0x81);     		// E-Vol setting
	lcd12864_wrcmd(lcd12864.ContrastLevel);   // (2byte command)
}

void lcd12864_LCDLighter(void)
{
	if (lcd12864.ContrastLevel>0x00)
	{
		lcd12864.ContrastLevel--;
	}
    lcd12864_wrcmd(0x81);            // E-Vol setting
	lcd12864_wrcmd(lcd12864.ContrastLevel);   // (2byte command)
}

lcd12864_t *bsp_lcd12864_init(void)
{
	lcd12864_t *pdev = &lcd12864;
	
	if (pdev->flags & DEF_FLAGS_12864_INIT) return pdev;

//	pdev->p_spi = &hspi2;
    bsp_lcd12864_reset();
	
	pdev->ContrastLevel = 0x18;// default Contrast Level
	lcd12864_wrcmd(0xaf);            // display on
	lcd12864_wrcmd(0x40);            // display start line=0
    lcd12864_wrcmd(0xa0);            // ADC=0
    lcd12864_wrcmd(0xa6);            // normal display
    lcd12864_wrcmd(0xa4);            // Display all point = off
    lcd12864_wrcmd(0xa2);            // LCD bias = 1/6 (duty=1/33)
    lcd12864_wrcmd(0xc8);            // Common output mode select=reverse

    lcd12864_wrcmd(0x2f);            // Power control = all on
   	lcd12864_wrcmd(0x23);			// RA/RB setting
   	lcd12864_wrcmd(0xf8);
	lcd12864_wrcmd(0x00);// Booster Ratio Set= 2x,3x,4x (2byte command)

	lcd12864_wrcmd(0x81);            // E-Vol setting
    lcd12864_wrcmd(pdev->ContrastLevel);   // (2byte command)
	
    pdev->flags |= DEF_FLAGS_12864_INIT;
    return pdev;
}

void lcd12864_test(void)
{
	lcd12864_WriteScreen(Logo);  
}


